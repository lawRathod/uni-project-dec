# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This project implements real membership inference attacks (MIA) on graph neural networks using synthetic data generated by DLGrapher to attack models trained on real data. The codebase consists of two main components:
- **DLGrapher-dev**: A diffusion-based graph generation framework for creating synthetic graphs
- **rebMIGraph**: Membership inference attack implementation (TSTS setting only)

### Critical Implementation Challenges Identified:
1. **Data Format Conversion**: Convert (pandas.DataFrame, networkx.Graph) tuples to torch_geometric.Data
2. **Feature Compatibility**: Ensure real vs synthetic data feature distributions align
3. **Multi-subgraph Training**: Adapt single-graph code to handle 256 synthetic subgraphs
4. **Classification Targets**: Binary classification on 'mature' (Twitch) and 'gender' (Event)
5. **Attack Transferability**: Measure synthetic→real attack effectiveness

## Common Development Commands

### DLGrapher Commands
```bash
# Run network generation (requires dataset name and batch size)
cd DLGrapher-dev
./run_net.sh <dataset_name> <batch_size>

# Run inference using makefile
make run-inference

# Main training command from src directory
cd src
python main.py dataset=<dataset> +experiment=<experiment> ++general.wandb=disabled
```

### Environment Setup
- Uses conda environment: `.env/`
- Python dependencies managed via `requirements.txt`
- PyTorch with CUDA 11.8 support
- Key packages: torch==2.2.2, torch_geometric==2.3.1, hydra-core==1.3.2

## Architecture

### DLGrapher Architecture
- **Entry point**: `src/main.py` - Handles training, testing, and model initialization
- **Models**: Three diffusion model types in `src/`:
  - `diffusion_model.py` - Continuous diffusion
  - `diffusion_model_discrete.py` - Discrete diffusion  
  - `diffusion_model_hybrid.py` - Hybrid approach
- **Configuration**: Hydra-based config system in `configs/`
  - Dataset configs: `configs/dataset/`
  - Experiment configs: `configs/experiment/`
  - Model configs: `configs/model/`
- **Datasets**: Custom dataset classes in `src/datasets/`
  - Abstract base: `abstract_dataset.py`
  - Implementations: `twitch_dataset.py`, `event_dataset.py`, etc.

### rebMIGraph Architecture
- **TSTS.py**: Train on Subgraph, Test on Subgraph setting (only implementation used)
- Implements membership inference attacks on GNN models (GCN, GAT, SAGE, SGC)
- TSTF setting not implemented as it requires a single large synthetic graph which DLGrapher doesn't generate

### Data Flow
1. **Synthetic Data Generation**: DLGrapher generates synthetic graphs from real datasets
2. **Data Format**: Datasets stored as pickled tuples of (pandas.DataFrame, networkx.Graph)
3. **Bridge Script**: `bridge.py` loads and verifies dataset formats
4. **Real MIA Attack Pipeline**: 
   - Target model: Trained on real data (`*_train.pt`)
   - Shadow model: Trained on synthetic data (`*_synth.pickle`)
   - Attack evaluation: Tested on real non-training data (`*_nontrain.pt`)

## Key Implementation Details

- **Checkpointing**: Models saved to `checkpoints/` directory
- **Sampling**: Uses random walk sampling with configurable min/max nodes (default: 120)
- **MIA Experiment Config**: `configs/experiment/tablegraph_mia.yaml`
  - 256 synthetic samples generated for final model
  - Batch size: 20, Training epochs: 10,000
- **No tests directory**: Testing is done through inference commands and evaluation metrics

## Dataset Structure

The project uses pickled datasets stored in `datasets/` directory with the following formats:

### Dataset Types
1. **Original datasets** (`*_original.pickle`):
   - Format: Single tuple `(pandas.DataFrame, networkx.Graph)`
   - DataFrame: Contains node features and labels
   - Graph: Contains the full graph structure

2. **Train/Test datasets** (`*_train.pt`, `*_nontrain.pt`):
   - Format: List of tuples `list[tuple[pandas.DataFrame, networkx.Graph]]`
   - Each tuple represents a subgraph sampled from the original
   - Used for training/testing GNN models

3. **Synthetic datasets** (`*_synth.pickle`):
   - Format: List of tuples, same as train/test format
   - Contains 256 synthetically generated graphs from DLGrapher
   - Each graph has exactly 120 nodes (matching the sampling parameters)
   - Example dimensions:
     - Twitch: 120 nodes, ~420 edges, 8 features per node
     - Event: 120 nodes, ~183 edges, 5 features per node

### Data Processing Flow
1. Original graph → Sample subgraphs → Train DLGrapher → Generate synthetic subgraphs
2. Real MIA attack setup:
   - Target model trains on real subgraphs to simulate victim's model
   - Shadow model trains on synthetic subgraphs to simulate attacker's knowledge
   - Attack model is trained on shadow posteriors and tested on target posteriors
3. This evaluates how well synthetic data can be used to infer membership in real models